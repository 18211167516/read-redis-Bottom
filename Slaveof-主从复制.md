## 前言:本文是对redis主从复制读后解读
1. 定义
> 在Redis中，用户可以通过执行slaveof命令，让一个服务器去复制另一个服务器，被复制的为主服务器，而对主服务器进行复制的服务器则被称为从服务器  
2. 复制功能划分
>1、同步（sync）将从服务器数据库状态更新到主服务器当前所处的数据库状态  
>2、命令传播（command propagate）主服务器数据库状态被修改，导致主从数据库状态不一致时，让主从服务器的数据库重新回到一致状态  
3. 同步（sync）
>1、当客户端向从服务器发送slaveof命令时，从服务器首先更新至主服务器当前所处的数据库状态  
>2、从服务器向主服务器发送sync命令  
>3、收到sync的主服务器执行bgsave命令，在后台生成rdb文件，并使用一个缓存区记录从现在开始执行的所有写命令  
>4、当主服务器的bgsave命令执行完之后，将rdb文件发送给从服务器，从服务器接受并载入这个rdb文件，将自己的数据库状态更新至最新  
>5、主服务器将记录在缓存区里面的所有写命令发送给从服务器，从服务器执行这些写命令，将自己的数据库状态更新至最新
4. 命令传播
> 每次主服务器执行写命令的时候，需要发送给从服务器，维持主从服务器数据库一致
5. 2.8版本以后 psync（完整重同步和部分重同步）
>1、完整重同步基本和sync一致  
>2、部分重同步解决了，断线后复制时的低效和耗时  
6. psync实现
>1、主从服务器的复制偏移量（记录复制到哪了），用于判断是否一致  
>2、主服务器的复制积压缓存区：固定长度的先进先出（FIFO）队列，默认1MB，当主服务器进行命令传播的时候，将命令写入缓存区，并且每个字节对应偏移量；如果偏移量offset+1的数据还存在于缓存区，执行部分重同步，否则，执行完整重同步；配置文件中 repl-backlog-size 修改缓存区大小  
>3、服务器的运行ID：运行时随机生成，当从服务器对主服务器进行初次复制的时，主服务器会将自己的运行ID传给从服务器，从记录，如果从服务器断线并重连上一个主服务器时，发送运行ID校验是否是同一个主服务器，如果是就尝试执行部分重同步，否则执行完整重同步  
7. psync调用方法
> 1、如果从服务器以前没有复制过任何服务器，或者之前执行过slaveof no one命令，那么从服务器一开始新的复制时将像主服务器发送psync ？-1，主动请求主服务器进行完整重同步  
> 2、否则直接发送：psync runid offset  
> 3、根据情况，接受到psync命令的主服务器会向从服务器返回以下3种回复：  
> 4、主服务器返回+fullresync runid offset,表示主服务器将与从服务器执行完整重同步；runid是该主服务器的运行id，从服务器会保存，下次发送psync命令时使用；offset 则是主服务器当前的复制偏移量，从服务器会将这个值作为初始化偏移量  
> 5、主服务器返回+continue回复，那么表示主服务器将与从服务器执行部分重同步  
> 6、主服务返回-err回复，表示版本低于2.8，无法识别psync命令，从服务器将向主服务器发送sync命令  
8. 复制的实现
> 1、slaveof master_ip master_port,当客户端像从服务器发送该命令时，从服务器首先将主服务器保存到服务器状态中（masterhost，masterport）  
> 2、建立套接字连接，如果从服务器创建的套接字成功connect到主服务器，那么从服务器将为该套接字关联一个处理复制工作的文件事件处理器（复制接受rdb文件，接受传播命令等等） 
> 3、从服务器成为主服务器的客户端后，先发送一个ping命令，检测套接字状态是否可读写，检测主服务器状态；会返回3个回复状态：
> 4、如果主服务器向从服务器返回了一个命令回复，但从服务器超时不能取出命令，从服务器断开（断开上边的套接字）并重新创建连向主服务器的套接字  
> 5、如果主服务器向从服务器返回一个错误，说明主服务器状态不佳，从服务器断开（断开上边的套接字）并重新创建连向主服务器的套接字  
> 6、如果从服务器读取到pong回复，表示主从服务器之间的网络连接状态正常，并且主服务器状态正常  
> 7、身份验证：如果从服务器设置了masterauth选项，进行验证；如果没有则不进行验证在需要验证的是，从服务器将向主服务器发送auth命令，命令为masterauth的值  
> 8、从服务器在身份验证简短会碰到以下几种情况：
> 9、主服务器没有设置requirepass选项，并且从服务器也没有设置masterauth，那么不验证  
> 10、从服务器通过auth发送密码和主服务器验证（一致就继续，否则返回invaild password）  
> 11、主服务设置了requirepass选项，但从服务器没有设置masterauth选项，那么主服务器将返回noauth错误，如果从设置了masterauth，主没有设置requirepass，会返回no password is set 错误  
> 12、发送端口信息：身份验证后，从服务器将执行命令replconf listening-port,像主服务器发送从服务器的监听端口号（其实就是像主服务器发送从服务器的端口号，主服务器记录）   
> 13、从服务器将向主服务器发送psync命令，执行同步，将自己的数据库状态更新至最新（主从是相互的客户端）  
> 14、命令传播：完成同步之后，主服务器会一直将自己执行的写命令发送给从服务器，而从服务器会一直接受并且执行主服务器发来的命令，保持主从一致  
> 15、心跳检测：在命令传播阶段，从服务器会默认每秒一次向主服务器发送命令 (replconf ack replication_offset(从服务器当前的偏移量))，作用是：  
> 16、检测主从服务器的连接状态  
> 17、辅助实现min-slave配置选项：min-slaves-to-write(从服务器数量) min-slaves-max-lag(从服务器的延迟值大于或等于该值)  
> 18、检测命令丢失 （判断如果主从偏移量不一致会重新发缺失的数据）
